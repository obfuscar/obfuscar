name: Windows

on: [push, pull_request]

permissions:
  contents: read
  packages: write

jobs:

  windows:

    runs-on: windows-latest

    steps:
    - name: Checkout repository (full history + submodules)
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        submodules: true

    - name: Setup .NET 8 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Setup .NET 9 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Setup .NET 10 SDK
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Build
      shell: cmd
      run: build.all.bat

    - name: Test
      shell: cmd
      run: test.bat

    - name: Publish NuGet packages to GitHub Packages
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
      shell: pwsh
      run: |
        # Only publish for tags that match v<major>.<minor>.<patch>-beta.<build> (e.g. v1.2.3-beta.1)
        $tag = $env:GITHUB_REF -replace '^refs/tags/', ''
        Write-Host "Detected tag: $tag"
        if ($tag -notmatch '^v\d+\.\d+\.\d+-beta\.\d+$') {
          Write-Host "Tag '$tag' does not match required pattern 'vx.x.x-beta.x'. Skipping publish."
          exit 0
        }

        ./pack.all.bat
        if ($LASTEXITCODE -ne 0) {
          Write-Host "Packaging failed. Exiting."
          exit $LASTEXITCODE
        }

        Write-Host "Publishing packages"
        dotnet nuget add source --username ${{ github.actor }} --password ${{ secrets.GITHUB_TOKEN }} --store-password-in-clear-text --name github "https://nuget.pkg.github.com/${{ github.repository_owner }}/index.json"
        $nupkgs = Get-ChildItem -Path . -Recurse -Filter *.nupkg
        if ($nupkgs.Count -eq 0) { Write-Host 'No packages found.'; exit 0 }
        foreach ($pkg in $nupkgs) {
          Write-Host "Pushing $($pkg.FullName)"
          dotnet nuget push $pkg.FullName --source github --skip-duplicate
        }
